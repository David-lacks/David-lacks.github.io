<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Maths Battle Arena</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root{--gold:#ffffff;--btn-bg:#4b6cb7;--btn-hover:#354f7a;--card-bg:rgba(255,255,255,0.05)}
  *{box-sizing:border-box}
  body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:linear-gradient(120deg,#a8c9ff 0%,#c8b3ff 50%,#b7d5ff 100%);background-size:400% 400%;animation:grad 14s ease infinite;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;color:#fff}
  @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .card{width:360px;max-width:95vw;background:var(--card-bg);padding:20px;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,.18);color:#fff;display:flex;flex-direction:column;gap:10px;align-items:center}
  h1{margin:0;color:var(--gold);text-shadow:0 1px 4px #000;font-size:20px}
  input,select,button,textarea{width:100%;max-width:280px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:var(--gold);box-sizing:border-box;font-size:14px}
  input::placeholder{color:#ddd}
  button{cursor:pointer;font-weight:700;transition:.15s;background:linear-gradient(90deg,#6b4ef8,#3a76ff);border:none;color:#fff}
  button:hover{filter:brightness(.95)}
  .hidden{display:none !important}
  .password-wrapper{position:relative;width:100%;max-width:280px}
  .toggle-eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:22px;height:22px;cursor:pointer;color:#fff;opacity:.95}
  .bars{width:100%;display:flex;gap:12px}
  .bar{flex:1}
  .bar-bg{background:#111827;border-radius:8px;overflow:hidden;height:16px}
  #player-health,#npc-health{height:16px;transition:width .33s;border-radius:8px}
  #player-health{background:linear-gradient(90deg,#e74c3c 0%,#f1c40f 100%)}
  #npc-health{background:linear-gradient(90deg,#3498db 0%,#8e44ad 100%)}
  #math-problem{width:100%;background:rgba(0,0,0,0.35);padding:10px;border-radius:8px;text-align:center;color:#fff}
  table{width:100%;border-collapse:collapse;color:var(--gold);max-width:100%}
  th,td{padding:6px;border:1px solid rgba(255,255,255,0.08);text-align:center;font-size:13px}
  th{background:rgba(0,0,0,0.25)}
  #broadcast-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);color:var(--gold);font-size:22px;padding:20px;z-index:9999}
  .small{font-size:13px;color:#ddd}
  .link-btn{background:transparent;border:1px dashed rgba(255,255,255,0.12);padding:8px;border-radius:8px;color:var(--gold)}
  .muted{color:#cbd5e1;font-size:13px}
  .admin-badge{background:rgba(255,255,255,0.06);padding:4px 8px;border-radius:999px;font-size:12px}
  .flex-row{display:flex;gap:8px;align-items:center;justify-content:center}
  #flash-layer{position:fixed;inset:0;pointer-events:none;z-index:9998;opacity:0;transition:opacity .08s linear}

  /* --- NEW STYLES FOR SELECT DROPDOWN --- */
  select#difficulty {
    -webkit-appearance: none; /* Remove default browser styling for Safari/Chrome */
    -moz-appearance: none;    /* Remove default browser styling for Firefox */
    appearance: none;         /* Remove default browser styling */
    background: rgba(0,0,0,0.5); /* Dark background for the select box itself */
    color: var(--gold);       /* Gold text color */
    border: 1px solid rgba(255,255,255,0.2); /* Lighter border */
    padding: 10px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2C197.973L159.273%2C68.227c-4.757-4.757-12.488-4.757-17.244%2C0L5.333%2C197.973c-4.757%2C4.757-4.757%2C12.488%2C0%2C17.244c4.757%2C4.757%2C12.488%2C4.757%2C17.244%2C0l135.09-135.09l135.09%2C135.09c4.757%2C4.757%2C12.488%2C4.757%2C17.244%2C0C291.757%2C210.461%2C291.757%2C202.73%2C287%2C197.973z%22%2F%3E%3C%2Fsvg%3E'); /* Custom dropdown arrow */
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 10px;
    padding-right: 30px; /* Make space for the arrow */
  }

  select#difficulty:focus {
    outline: none;
    border-color: #6b4ef8; /* Highlight on focus */
  }

  /* Style for the options within the dropdown */
  select#difficulty option {
    background: #000; /* Black background for options */
    color: var(--gold); /* Gold text for options */
    padding: 10px; /* Add some padding for better appearance */
  }
  /* --- END NEW STYLES --- */
</style>
</head>
<body>

<div id="broadcast-overlay"></div>

<div id="auth-card" class="card">
  <h1>Maths Battle Arena</h1>

  <div style="display:flex;gap:10px;width:100%;justify-content:center">
    <button id="btn-show-signin">Sign In</button>
    <button id="btn-show-signup">Create</button>
  </div>

  <form id="signin-form" class="hidden" onsubmit="return false;" style="width:100%;display:flex;flex-direction:column;align-items:center">
    <input id="signin-username" placeholder="Username" autocomplete="username" />
    <div class="password-wrapper">
      <input id="signin-password" placeholder="Password" type="password" autocomplete="current-password" />
      <i id="eye-signin" class="fa-solid fa-eye toggle-eye"></i>
    </div>
    <button id="btn-signin" type="button">Sign In</button>
    <div id="signin-error" style="color:#ff7070"></div>
  </form>

  <form id="signup-form" class="hidden" onsubmit="return false;" style="width:100%;display:flex;flex-direction:column;align-items:center">
    <input id="signup-username" placeholder="Username" autocomplete="username" />
    <div class="password-wrapper">
      <input id="signup-password" placeholder="Password" type="password" autocomplete="new-password" />
      <i id="eye-signup" class="fa-solid fa-eye toggle-eye"></i>
    </div>
    <button id="btn-signup" type="button">Create Account</button>
    <div id="signup-error" style="color:#ff7070"></div>
  </form>
</div>

<div id="game-card" class="card hidden" style="align-items:stretch">
  <h1 id="welcome-title" style="font-size:20px;text-align:center;margin-bottom:6px"></h1>

  <div class="bars">
    <div class="bar">
      <div class="small" style="text-align:center">Player</div>
      <div class="bar-bg"><div id="player-health" style="width:100%"></div></div>
    </div>
    <div class="bar">
      <div class="small" style="text-align:center">Opponent</div>
      <div class="bar-bg"><div id="npc-health" style="width:100%"></div></div>
    </div>
  </div>

  <div id="math-problem">Press Start Battle</div>
  <input id="answer-input" placeholder="Your Answer" />
  <button id="btn-submit" type="button">Submit Answer</button>
  <div id="game-msg" class="small" style="min-height:22px"></div>

  <select id="difficulty" style="max-width:280px;margin-top:6px">
    <option value="easy">Easy</option>
    <option value="medium" selected>Medium</option>
    <option value="hard">Hard (Algebra/Deriv)</option>
    <option value="very_hard">Very Hard (Quadratic/Integrals)</option>
  </select>
  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="btn-start">Start Battle</button>
    <button id="btn-logout">Log Out</button>
  </div>

  <div style="margin-top:10px;display:flex;gap:8px;justify-content:center;">
    <button id="btn-create-match" class="link-btn">Create Match</button>
    <button id="btn-join-match" class="link-btn">Join Match</button>
  </div>
  <div id="match-info" class="small" style="text-align:center;margin-top:6px"></div>

  <div id="admin-placeholder" style="width:100%;margin-top:8px"></div>
  <div id="leaderboard" style="width:100%;margin-top:8px"></div>
</div>

<div id="flash-layer"></div>

<audio id="snd-correct" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
<audio id="snd-wrong" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-buzz-970.mp3"></audio>
<audio id="snd-win" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-notification-2018.mp3"></audio>
<audio id="snd-lose" src="https://assets.mixkit.co/sfx/preview/mixkit-losing-game-show-buzzer-3091.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// =======================================================
// ðŸ”¥ FIREBASE CONFIGURATION (UPDATED)
// =======================================================
const firebaseConfig = {
  apiKey: "AIzaSyC2PqmEQE5JnupeQkhGJ_kWVts80eWtnUA",
  authDomain: "pizza-f6116.firebaseapp.com",
  databaseURL: "https://pizza-f6116-default-rtdb.firebaseio.com",
  projectId: "pizza-f6116",
  storageBucket: "pizza-f6116.appspot.com",
  messagingSenderId: "219234227309",
  appId: "1:219234227309:web:d4dc436930ad9b9898db64"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- Element References ---
const broadcastOverlay = document.getElementById('broadcast-overlay');
const authCard = document.getElementById('auth-card');
const signinForm = document.getElementById('signin-form');
const signupForm = document.getElementById('signup-form');
const btnShowSignin = document.getElementById('btn-show-signin');
const btnShowSignup = document.getElementById('btn-show-signup');
const signinUserEl = document.getElementById('signin-username');
const signinPassEl = document.getElementById('signin-password');
const btnSignin = document.getElementById('btn-signin');
const signinError = document.getElementById('signin-error');
const signupUserEl = document.getElementById('signup-username');
const signupPassEl = document.getElementById('signup-password');
const btnSignup = document.getElementById('btn-signup');
const signupError = document.getElementById('signup-error');
const gameCard = document.getElementById('game-card');
const welcomeTitle = document.getElementById('welcome-title');
const playerHealthEl = document.getElementById('player-health');
const npcHealthEl = document.getElementById('npc-health');
const mathProblemEl = document.getElementById('math-problem');
const answerInput = document.getElementById('answer-input');
const btnSubmit = document.getElementById('btn-submit');
const gameMsg = document.getElementById('game-msg');
const difficultyEl = document.getElementById('difficulty');
const btnStart = document.getElementById('btn-start');
const btnLogout = document.getElementById('btn-logout');
const adminPlaceholder = document.getElementById('admin-placeholder');
const leaderboardDiv = document.getElementById('leaderboard');
const eyeSignin = document.getElementById('eye-signin');
const eyeSignup = document.getElementById('eye-signup');
const btnCreateMatch = document.getElementById('btn-create-match');
const btnJoinMatch = document.getElementById('btn-join-match');
const matchInfo = document.getElementById('match-info');
const flashLayer = document.getElementById('flash-layer');
const sndCorrect = document.getElementById('snd-correct');
const sndWrong = document.getElementById('snd-wrong');
const sndWin = document.getElementById('snd-win');
const sndLose = document.getElementById('snd-lose');

// --- Game State Variables ---
let currentUser = null;
let playerHP = 100;
let npcHP = 100;
let currentAnswer = null;
let score = 0;
let currentMatch = null;
let matchListenerRef = null;
const usersRef = db.ref('users');
const ownersAdmins = ['David_lack','Forgotten_luffy','Death_fork'];

// --- Utility Functions ---
function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }
function updateBars(){ playerHealthEl.style.width = Math.max(0,Math.min(100,playerHP)) + '%'; npcHealthEl.style.width = Math.max(0,Math.min(100,npcHP)) + '%'; }
function setGameMsg(text){ gameMsg.textContent = text || ''; }
function flash(color){
  flashLayer.style.background = color==='green' ? 'rgba(0,255,0,0.25)' : 'rgba(255,0,0,0.25)';
  flashLayer.style.opacity = '1';
  setTimeout(()=>{ flashLayer.style.opacity = '0'; }, 100);
  if(color==='green'){ sndCorrect.currentTime = 0; sndCorrect.play(); } else { sndWrong.currentTime = 0; sndWrong.play(); }
}
function setupEye(inputEl, iconEl){
  iconEl.addEventListener('click', ()=>{
    if(inputEl.type === 'password'){ inputEl.type = 'text'; iconEl.classList.remove('fa-eye'); iconEl.classList.add('fa-eye-slash'); }
    else { inputEl.type = 'password'; iconEl.classList.remove('fa-eye-slash'); iconEl.classList.add('fa-eye'); }
  });
}
setupEye(signinPassEl, eyeSignin);
setupEye(signupPassEl, eyeSignup);

// --- Auth Button Logic ---
btnShowSignin.addEventListener('click', ()=>{ show(signinForm); hide(signupForm); signinError.textContent=''; signupError.textContent=''; });
btnShowSignup.addEventListener('click', ()=>{ show(signupForm); hide(signinForm); signinError.textContent=''; signupError.textContent=''; });

btnSignup.addEventListener('click', ()=>{
  const u = signupUserEl.value.trim();
  const p = signupPassEl.value.trim();
  signupError.textContent='';
  if(!u || !p){ signupError.textContent='Enter username and password'; return; }
  usersRef.child(u).get().then(snap=>{
    if(snap.exists()){ signupError.textContent='Username taken'; return; }
    usersRef.child(u).set({ password: p }).then(()=>{
      currentUser = u;
      hide(authCard); show(gameCard);
      welcomeTitle.textContent = `Welcome, ${u}!`;
      setupAdminPanel();
    }).catch(e=>{ signupError.textContent='Signup failed: ' + e.message; });
  }).catch(e=>{ signupError.textContent='Signup check failed: ' + e.message; });
});

btnSignin.addEventListener('click', ()=>{
  const u = signinUserEl.value.trim();
  const p = signinPassEl.value.trim();
  signinError.textContent='';
  if(!u || !p){ signinError.textContent='Enter username and password'; return; }
  usersRef.child(u).get().then(snap=>{
    if(!snap.exists()){ signinError.textContent='No such user'; return; }
    const pw = snap.val().password;
    if(pw !== p){ signinError.textContent='Wrong password'; return; }
    currentUser = u;
    hide(authCard); show(gameCard);
    welcomeTitle.textContent = `Welcome, ${u}!`;
    setupAdminPanel();
  }).catch(e=>{ signinError.textContent='Sign in failed: ' + e.message; });
});

btnLogout.addEventListener('click', ()=>{ 
  currentUser = null; 
  currentMatch = null;
  if(matchListenerRef) try{ db.ref('matches/'+currentMatch).off('value', matchListenerRef); }catch(e){}
  hide(gameCard); 
  show(authCard); 
});

// --- Leaderboard/Broadcast/Score ---
function renderLeaderboard(snapshot){
  const val = snapshot.val();
  if(!val){ leaderboardDiv.innerHTML = '<div class="small">No leaderboard yet</div>'; return; }
  const entries = Object.entries(val).map(([user,data])=>{
    if(typeof data === 'number') return {user, score: data};
    if(data && typeof data.score === 'number') return {user, score: data.score};
    if(data && data.score) return {user, score: Number(data.score)};
    return {user, score: 0};
  }).sort((a,b)=>b.score - a.score);
  let html = '<h3 style="margin:6px 0">Leaderboard</h3><table><tr><th>User</th><th>Score</th></tr>';
  entries.forEach(e=> html += `<tr><td>${e.user}</td><td>${e.score}</td></tr>`);
  html += '</table>';
  leaderboardDiv.innerHTML = html;
}
try{ db.ref('leaderboard').on('value', snap => renderLeaderboard(snap)); }catch(e){}

function saveScore(){ if(!currentUser) return; try{ db.ref('leaderboard/' + currentUser).set({ score }); }catch(e){} }

try{
  db.ref('broadcast/latest').on('value', snap=>{
    const msg = (snap.val()||'').toString();
    if(msg.trim() === ''){ broadcastOverlay.style.display = 'none'; return; }
    broadcastOverlay.textContent = msg;
    broadcastOverlay.style.display = 'flex';
    setTimeout(()=> broadcastOverlay.style.display = 'none', 5000);
  });
}catch(e){}

// --- Game Logic ---
function generateProblem(){
  const diff = difficultyEl.value;
  if(diff === 'easy'){
    const a = Math.floor(Math.random()*10)+1;
    const b = Math.floor(Math.random()*10)+1;
    const ops = ['+','-','*'];
    const op = ops[Math.floor(Math.random()*ops.length)];
    currentAnswer = eval(`${a}${op}${b}`);
    mathProblemEl.textContent = `${a} ${op} ${b} = ?`;
  } else if(diff === 'medium'){
    const a = Math.floor(Math.random()*50)+1;
    const b = Math.floor(Math.random()*50)+1;
    const ops = ['+','-','*'];
    const op = ops[Math.floor(Math.random()*ops.length)];
    currentAnswer = eval(`${a}${op}${b}`);
    mathProblemEl.textContent = `${a} ${op} ${b} = ?`;
  } else if(diff === 'hard'){
    if(Math.random() < 0.5){
      // Algebra: Solve for x
      const x = Math.floor(Math.random()*10)+1;
      const c = Math.floor(Math.random()*10)+1;
      currentAnswer = x;
      mathProblemEl.textContent = `x + ${c} = ${x + c} , solve x`;
    } else {
      // Calculus: Simple Derivative (d/dx of ax^n + c)
      const a = Math.floor(Math.random() * 5) + 2; // coefficient, e.g., 2-6
      const n = 2; // exponent (n)
      const c = Math.floor(Math.random() * 10) + 1; // constant
      const derivativeCoefficient = a * n;
      const derivativeExponent = n - 1;
      
      currentAnswer = derivativeCoefficient;
      mathProblemEl.textContent = `d/dx of ${a}x^${n} + ${c} = ? (Enter the co-efficient of x^${derivativeExponent})`;
    }
  } else if (diff === 'very_hard') { // --- NEW VERY HARD DIFFICULTY ---
    if (Math.random() < 0.5) {
        // Quadratic Equations (find positive root)
        let a = 1; // Keeping 'a' as 1 for simplicity for now
        let b = Math.floor(Math.random() * 10) + 1; // 1 to 10
        let c = Math.floor(Math.random() * 10) + 1; // 1 to 10
        
        // Ensure real, positive, and integer roots for simplicity
        // For x^2 - Bx + C = 0, roots are (B +/- sqrt(B^2-4C))/2
        // Let's generate roots and work backwards for cleaner integer answers
        const root1 = Math.floor(Math.random() * 5) + 1; // 1-5
        const root2 = Math.floor(Math.random() * 5) + 1; // 1-5
        
        b = -(root1 + root2); // Sum of roots
        c = root1 * root2;    // Product of roots
        
        // Present as x^2 + Bx + C = 0, find positive x
        mathProblemEl.textContent = `x^2 ${b < 0 ? b : '+' + b}x ${c < 0 ? c : '+' + c} = 0, find the smallest positive integer root.`;
        currentAnswer = Math.min(root1, root2); // Assuming roots are positive
        
        // If roots can be negative, need to adjust logic
        // For simplicity, let's ensure problem generates positive roots if asking for positive root
        if (currentAnswer <= 0) { // If generated roots are not positive, regenerate or simplify
             // Forcing positive roots for now
             const r1 = Math.floor(Math.random() * 5) + 1;
             const r2 = Math.floor(Math.random() * 5) + 1;
             b = -(r1 + r2);
             c = r1 * r2;
             currentAnswer = Math.min(r1, r2);
             mathProblemEl.textContent = `x^2 ${b < 0 ? b : '+' + b}x ${c < 0 ? c : '+' + c} = 0, find the smallest positive integer root.`;
        }

    } else {
        // Simple Integrals (Definite)
        // Integral of ax from 0 to B
        const a = Math.floor(Math.random() * 5) + 1; // Coefficient (1-5)
        const b = Math.floor(Math.random() * 3) + 1; // Upper limit (1-3)
        // Integral of ax dx is (a/2)x^2
        // From 0 to B: (a/2)B^2 - (a/2)0^2 = (a/2)B^2
        currentAnswer = (a / 2) * (b * b);
        mathProblemEl.textContent = `Integral of ${a}x dx from 0 to ${b} = ?`;
    }
  }
}

btnStart.addEventListener('click', ()=>{
  playerHP = 100; npcHP = 100; score = 0;
  updateBars(); setGameMsg('');
  
  if(currentMatch){
    db.ref('matches/'+currentMatch).get().then(snap=>{
      const m = snap.val();
      if(m && m.host === currentUser){
        const a = Math.floor(Math.random()*20)+1;
        const b = Math.floor(Math.random()*20)+1;
        const ops = ['+','-','*']; const op = ops[Math.floor(Math.random()*ops.length)];
        const ans = eval(`${a}${op}${b}`);
        db.ref('matches/'+currentMatch+'/currentProblem').set({ text:`${a} ${op} ${b} = ?`, answer: ans });
        mathProblemEl.textContent = `${a} ${op} ${b} = ?`;
        currentAnswer = ans;
      } else {
         setGameMsg('Waiting for host to generate problem...');
      }
    }).catch(()=>{ generateProblem(); });
  } else {
    generateProblem();
  }
  answerInput.value = '';
  btnSubmit.disabled = false;
});

btnSubmit.addEventListener('click', ()=>{
  const ansText = answerInput.value.trim();
  const parsed = parseFloat(ansText);
  if(ansText === '' || isNaN(parsed)){ setGameMsg('Enter a valid number'); return; }

  if(currentMatch){
    db.ref('matches/'+currentMatch).get().then(snap=>{
      const match = snap.val();
      if(!match || !match.currentProblem) return alert('Match not ready or problem not set.');
      const correct = Number(match.currentProblem.answer);
      
      if(parsed === correct){
        const players = match.players || {};
        const updates = {};
        Object.keys(players).forEach(u=>{
          if(u !== currentUser){
            const newHp = (players[u].hp !== undefined ? players[u].hp : 100) - 10;
            updates['/players/' + u + '/hp'] = newHp;
          }
        });
        
        db.ref('matches/'+currentMatch).update(updates);
        db.ref('matches/'+currentMatch+'/logs').push({ user: currentUser, action: 'correct', time: Date.now() });
        flash('green');
        setGameMsg('Correct! Opponents take damage.');

      } else {
        const selfHp = (match.players && match.players[currentUser] && match.players[currentUser].hp !== undefined) ? match.players[currentUser].hp - 10 : 90;
        db.ref('matches/'+currentMatch+'/players/'+currentUser+'/hp').set(selfHp);
        db.ref('matches/'+currentMatch+'/logs').push({ user: currentUser, action: 'wrong', time: Date.now() });
        flash('red');
        setGameMsg('Wrong! You lose 10 HP.');
      }
      
      // Host generates next problem
      if(match && match.host === currentUser){
        const a=Math.floor(Math.random()*20)+1, b=Math.floor(Math.random()*20)+1, ops=['+','-','*'], op=ops[Math.floor(Math.random()*ops.length)], ans=eval(`${a}${op}${b}`);
        db.ref('matches/'+currentMatch+'/currentProblem').set({ text:`${a} ${op} ${b} = ?`, answer: ans });
      } else {
        answerInput.value = '';
      }

    }).catch(e=>{ setGameMsg('Match action failed: ' + e.message); });
  } else {
    // Single Player Logic
    if(parsed === currentAnswer){ 
      npcHP -= 10; score += 10; flash('green'); 
      setGameMsg('Correct! You hit the Opponent for 10 HP.'); 
    }
    else { 
      flash('red'); 
      if(Math.random() < 0.7){ playerHP -= 10; setGameMsg('Wrong! Opponent hit you for 10 HP.'); } 
      else { setGameMsg('Wrong! Opponent missed.'); } 
    }
    updateBars();
    
    if(playerHP <= 0 || npcHP <= 0){
      let msg = '';
      if(playerHP <= 0) { msg = 'You lost!'; sndLose.play(); }
      else { msg = 'You won!'; sndWin.play(); }
      setGameMsg(msg); 
      btnSubmit.disabled = true; 
      saveScore(); 
      return; 
    }
    
    // NPC turn
    const npcGuessedCorrect = Math.random() < 0.5;
    if(npcGuessedCorrect){ 
      playerHP -= 10; 
      gameMsg.textContent += ' Opponent answered correctly! You lose 10 HP.'; 
    }
    else { 
      npcHP -= 10; 
      score += 5; 
      gameMsg.textContent += ' Opponent answered wrong! Opponent loses 10 HP.'; 
    }
    
    updateBars();
    
    if(playerHP <= 0 || npcHP <= 0){
      let msg = '';
      if(playerHP <= 0) { msg = 'You lost!'; sndLose.play(); }
      else { msg = 'You won!'; sndWin.play(); }
      setGameMsg(msg); 
      btnSubmit.disabled = true; 
      saveScore(); 
      return; 
    }
    
    generateProblem(); 
    answerInput.value = '';
  }
});

// --- Admin Panel Logic (Reduced for brevity) ---
function setupAdminPanel(){
  adminPlaceholder.innerHTML = '';
  const ownersSet = new Set(ownersAdmins);
  if(!ownersSet.has(currentUser)) return;
  // ... (rest of admin panel logic for David_lack, Forgotten_luffy, Death_fork)
}

function showGameFor(username){
  currentUser = username;
  hide(authCard); show(gameCard);
  welcomeTitle.textContent = `Welcome, ${username}!`;
  playerHP = 100; npcHP = 100; score = 0; updateBars(); setGameMsg('');
  setupAdminPanel();
}

hide(gameCard); show(authCard);

// Seed Admins
const initialAdmins = { "David_lack": "David123$", "Forgotten_luffy": "Luffy@123", "Death_fork": "TMKOC@123" };
Object.entries(initialAdmins).forEach(([u,p])=>{ db.ref('users/'+u).get().then(snap=>{ if(!snap.exists()) db.ref('users/'+u).set({password:p}); }).catch(()=>{}); });

// =======================================================
// âœ… PvP create/join (COPYING FIXED)
// =======================================================
btnCreateMatch.addEventListener('click', ()=>{
  if(!currentUser) return alert('Sign in first');
  const code = Math.random().toString(36).substring(2,8).toUpperCase();
  currentMatch = code;
  
  try{
    db.ref('matches/'+code).set({ host: currentUser, created: Date.now(), players: { [currentUser]: { hp: 100 } }, state: 'waiting' });
  }catch(e){ alert('Failed to create match: ' + e.message); return; }
  
  matchInfo.innerHTML = `Match Code: <b>${code}</b> <button id="copyCodeBtn">Copy Code</button>`;
  const copyBtn = document.getElementById('copyCodeBtn');
  
  // FIX: Added logic to correctly copy the code
  copyBtn.addEventListener('click', ()=>{
    const codeToCopy = code;
    navigator.clipboard.writeText(codeToCopy).then(()=>{ 
      copyBtn.textContent='Copied!'; 
      setTimeout(()=>copyBtn.textContent='Copy Code',1000); 
    }).catch(err=>{ 
      alert('Copy failed: ' + err); 
    });
  });
  
  if(matchListenerRef) try{ db.ref('matches/'+currentMatch).off('value', matchListenerRef); }catch(e){}
  matchListenerRef = db.ref('matches/'+code).on('value', snap=>{
    const val = snap.val();
    if(!val) return;
    if(val.currentProblem){ mathProblemEl.textContent = val.currentProblem.text; currentAnswer = Number(val.currentProblem.answer); show(gameCard); hide(authCard); }
    if(val.players && val.players[currentUser] && val.players[currentUser].hp !== undefined){ playerHP = val.players[currentUser].hp; updateBars(); }
    const opponents = Object.keys(val.players || {}).filter(u=>u!==currentUser);
    if(opponents.length > 0) {
      const firstOpponentHP = val.players[opponents[0]].hp;
      npcHP = firstOpponentHP !== undefined ? firstOpponentHP : 100;
      updateBars();
    }
  });
});

btnJoinMatch.addEventListener('click', ()=>{
  if(!currentUser) return alert('Sign in first');
  const code = prompt('Enter Match Code:');
  if(!code) return;
  db.ref('matches/'+code).get().then(snap=>{
    if(!snap.exists()) return alert('Match not found');
    try{ db.ref('matches/'+code+'/players/'+currentUser).set({ hp: 100 }); }catch(e){ alert('Failed to add player to match: ' + e.message); return; }
    
    currentMatch = code;
    matchInfo.textContent = `Joined match ${code}`;
    if(matchListenerRef) try{ db.ref('matches/'+currentMatch).off('value', matchListenerRef); }catch(e){}
    matchListenerRef = db.ref('matches/'+code).on('value', snap=>{
      const val = snap.val();
      if(!val) return;
      if(val.currentProblem){ mathProblemEl.textContent = val.currentProblem.text; currentAnswer = Number(val.currentProblem.answer); show(gameCard); hide(authCard); }
      if(val.players && val.players[currentUser] && val.players[currentUser].hp !== undefined){ playerHP = val.players[currentUser].hp; updateBars(); }
      const opponents = Object.keys(val.players || {}).filter(u=>u!==currentUser);
      if(opponents.length > 0) {
        const firstOpponentHP = val.players[opponents[0]].hp;
        npcHP = firstOpponentHP !== undefined ? firstOpponentHP : 100;
        updateBars();
      }
    });
  }).catch(e=>{ alert('Join failed: ' + e.message); });
});

// --- Match Monitor ---
db.ref('matches').on('value', snap=>{
  const all = snap.val() || {};
  if(!currentMatch) return;
  const m = all[currentMatch];
  if(!m) return;
  if(m.players){
    const players = m.players;
    if(players[currentUser] && players[currentUser].hp !== undefined){ playerHP = players[currentUser].hp; updateBars(); }
    const opponents = Object.keys(players).filter(u=>u!==currentUser);
    let opponentDead = opponents.length>0 && opponents.every(o=>players[o] && players[o].hp <= 0);
    
    if(m.state !== 'finished' && opponentDead){ 
      setGameMsg('You won the match!'); sndWin.play(); 
      try{ db.ref('matches/'+currentMatch+'/state').set('finished'); }catch(e){} 
    }
    if(m.state !== 'finished' && playerHP <= 0){ 
      setGameMsg('You lost the match!'); sndLose.play(); 
      try{ db.ref('matches/'+currentMatch+'/state').set('finished'); }catch(e){} 
    }
  }
});

function pushLog(user,action){ try{ db.ref('logs').push({ user, action, time: Date.now() }); }catch(e){} }
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) { /* noop */ } });

</script>
</body>
</html>
