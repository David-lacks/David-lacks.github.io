<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chudcord — Chat</title>

  <!-- Favicon (embedded data URI) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%235865f2'/%3E%3Ctext x='50' y='58' font-size='52' text-anchor='middle' fill='white' font-family='Arial, Helvetica, sans-serif'%3Ec%3C/text%3E%3C/svg%3E">

  <!-- Web app manifest -->
  <link rel="manifest" href="manifest.json">

  <meta name="theme-color" content="#5865f2">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{ --bg:#07101a; --panel:#111622; --muted:#9aa3ad; --accent:#5865f2; --white:#e6eef6; --input:#0f1622; --danger:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#071425);color:var(--white);min-height:100vh}
    .center{max-width:980px;margin:28px auto;padding:16px}
    .card{background:linear-gradient(180deg,#12151a,#0d1114);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 8px 0;font-size:20px}
    label{display:block;margin-top:12px;font-size:13px;color:var(--muted)}
    .field{width:100%;background:var(--input);border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03);color:var(--white);margin-top:8px;font-size:15px}
    .row{display:flex;gap:8px}
    .btn{background:var(--accent);border:none;color:white;padding:10px 12px;border-radius:8px;cursor:pointer}
    .muted{font-size:12px;color:var(--muted);margin-top:8px}
    /* small responsive layout */
    @media (max-width:720px){
      .center{margin:12px}
    }
    /* chat layout */
    .layout{display:flex;gap:12px;align-items:flex-start}
    .servers{width:64px;background:#0b1220;border-radius:10px;padding:8px;display:flex;flex-direction:column;gap:8px;align-items:center}
    .channels{width:220px;background:var(--panel);border-radius:10px;padding:10px}
    .chatbox{flex:1;background:var(--panel);border-radius:10px;padding:10px;display:flex;flex-direction:column;min-height:480px}
    .messages{flex:1;overflow:auto;padding:8px}
    .composer{display:flex;gap:8px;margin-top:8px}
    .avatar{width:36px;height:36px;border-radius:8px;background:#253043;display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <main class="center">

    <!-- Simple header -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
      <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#4f57e6,#3a3fd1);display:flex;align-items:center;justify-content:center;font-weight:700">C</div>
      <div>
        <div style="font-weight:700">Chudcord</div>
        <div class="muted" id="topSub">Small chat app</div>
      </div>
      <div style="margin-left:auto">
        <button id="btnRepo" class="btn" style="background:rgba(255,255,255,0.06);color:var(--white)">Repo info</button>
      </div>
    </div>

    <!-- Views: login, chat, profile (single file app, simple routing via hash) -->
    <section id="view-login" class="card">
      <h1>Create account / Sign in</h1>
      <p class="muted">Create an account, or sign in. (Serve this page over HTTP or GitHub Pages — ES modules won't load from file://.)</p>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="showSignup" class="btn">Create Account</button>
        <button id="showSignin" class="btn" style="background:rgba(255,255,255,0.06);color:var(--white)">Sign In</button>
      </div>

      <div id="signupPanel" style="margin-top:12px">
        <label>Email *</label>
        <input id="suEmail" class="field" type="email">

        <label>Username *</label>
        <input id="suUsername" class="field">

        <label>Password *</label>
        <input id="suPassword" class="field" type="password">

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="createBtn" class="btn">Create</button>
          <button id="createGoogleBtn" class="btn" style="background:rgba(255,255,255,0.06);color:var(--white)">Google</button>
        </div>
      </div>

      <div id="signinPanel" style="display:none;margin-top:12px">
        <label>Email</label>
        <input id="siEmail" class="field" type="email">
        <label>Password</label>
        <input id="siPassword" class="field" type="password">
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="signInBtn" class="btn">Sign In</button>
          <button id="resetBtn" class="btn" style="background:rgba(255,255,255,0.06);color:var(--white)">Reset password</button>
        </div>
      </div>
    </section>

    <!-- Chat view -->
    <section id="view-chat" class="card" style="display:none;margin-top:12px">
      <div class="layout">
        <div class="servers" aria-hidden="true">
          <div style="width:40px;height:40px;border-radius:8px;background:#2a3340;display:flex;align-items:center;justify-content:center">C</div>
        </div>

        <div class="channels">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Channels</strong></div>
            <div id="userBadge" class="muted">Not signed in</div>
          </div>
          <div style="margin-top:8px">
            <div class="muted">Text</div>
            <div style="margin-top:8px">
              <div class="muted channelItem" data-room="general"># general</div>
              <div class="muted channelItem" data-room="random"># random</div>
            </div>
          </div>
        </div>

        <div class="chatbox">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div><strong id="roomTitle"># general</strong></div>
            <div>
              <button id="openProfile" class="btn" style="background:rgba(255,255,255,0.06);color:var(--white)">Profile</button>
              <button id="signOut" class="btn" style="background:var(--danger);display:none">Sign out</button>
            </div>
          </div>

          <div class="messages" id="messages"></div>

          <div class="composer">
            <input id="msgInput" class="field" placeholder="Message..." style="flex:1">
            <button id="sendMsg" class="btn">Send</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Profile view -->
    <section id="view-profile" class="card" style="display:none;margin-top:12px">
      <h1>Profile</h1>
      <div style="display:flex;gap:12px;align-items:center">
        <div id="avatar" style="width:72px;height:72px;border-radius:10px;background:#253043;display:flex;align-items:center;justify-content:center;font-size:28px">U</div>
        <div>
          <div id="pName" style="font-weight:700">Not signed in</div>
          <div id="pEmail" class="muted"></div>
        </div>
      </div>

      <label style="margin-top:12px">Display name</label>
      <input id="pfDisplay" class="field">

      <label>Change email</label>
      <input id="pfEmail" class="field">

      <label>New password</label>
      <input id="pfPass" class="field" type="password">

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="saveProfile" class="btn">Save</button>
        <button id="deleteAcc" class="btn" style="background:var(--danger)">Delete account</button>
        <button id="backChat" class="btn" style="background:rgba(255,255,255,0.06);margin-left:auto">Back</button>
      </div>
    </section>

  </main>

  <!-- Minimal, self-contained JS -->
  <script type="module">
    // NOTE: Must be served over HTTP or HTTPS (not file://) so ES modules and Firebase work.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      sendEmailVerification, signOut, sendPasswordResetEmail, updateProfile, updateEmail, updatePassword, deleteUser, reauthenticateWithCredential, EmailAuthProvider
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    import {
      getDatabase, ref, push, onChildAdded, query, limitToLast, get, set, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // --- Firebase config (your values) ---
    const firebaseConfig = {
      apiKey: "AIzaSyClpOt6HnUl0qwFr1NytfuSurhBoagCHL8",
      authDomain: "chatting-29d11.firebaseapp.com",
      databaseURL: "https://chatting-29d11-default-rtdb.firebaseio.com",
      projectId: "chatting-29d11",
      storageBucket: "chatting-29d11.firebasestorage.app",
      messagingSenderId: "1018454045492",
      appId: "1:1018454045492:web:2509f900062e9c15f36b61"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Element refs
    const viewLogin = document.getElementById('view-login');
    const viewChat = document.getElementById('view-chat');
    const viewProfile = document.getElementById('view-profile');

    const showSignup = document.getElementById('showSignup');
    const showSignin = document.getElementById('showSignin');
    const signupPanel = document.getElementById('signupPanel');
    const signinPanel = document.getElementById('signinPanel');

    const createBtn = document.getElementById('createBtn');
    const createGoogleBtn = document.getElementById('createGoogleBtn');
    const signInBtn = document.getElementById('signInBtn');
    const resetBtn = document.getElementById('resetBtn');

    const suEmail = document.getElementById('suEmail'), suUsername = document.getElementById('suUsername'), suPassword = document.getElementById('suPassword');
    const siEmail = document.getElementById('siEmail'), siPassword = document.getElementById('siPassword');

    const userBadge = document.getElementById('userBadge');
    const openProfile = document.getElementById('openProfile'), signOutBtn = document.getElementById('signOut');

    const messagesEl = document.getElementById('messages'), sendMsg = document.getElementById('sendMsg'), msgInput = document.getElementById('msgInput');

    const pfDisplay = document.getElementById('pfDisplay'), pfEmail = document.getElementById('pfEmail'), pfPass = document.getElementById('pfPass');
    const saveProfile = document.getElementById('saveProfile'), deleteAcc = document.getElementById('deleteAcc'), backChat = document.getElementById('backChat');

    const btnRepo = document.getElementById('btnRepo');

    // Small UI helpers
    function show(view){ viewLogin.style.display='none'; viewChat.style.display='none'; viewProfile.style.display='none'; view.style.display='block'; }
    show(viewLogin);

    showSignup.onclick = ()=> { signupPanel.style.display='block'; signinPanel.style.display='none'; };
    showSignin.onclick = ()=> { signupPanel.style.display='none'; signinPanel.style.display='block'; };

    // Repo info button (simple alert)
    btnRepo.addEventListener('click', ()=> {
      alert('Repo: David-lacks/David-lacks.github.io\nLanguages: HTML 100%');
    });

    // Auth: Google
    async function googleSign() {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
        // Firebase onAuthStateChanged will handle UI
      } catch(e){ alert('Google sign-in failed: '+e.message); }
    }
    createGoogleBtn.addEventListener('click', googleSign);

    // Create account
    createBtn.addEventListener('click', async () => {
      const email = suEmail.value.trim(), password = suPassword.value, username = suUsername.value.trim();
      if (!email || !password || !username) return alert('Fill email, username and password.');
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        // set displayName
        try { await updateProfile(cred.user, { displayName: username }); } catch {}
        try { await sendEmailVerification(cred.user); } catch {}
        alert('Account created. Check your email for verification.');
      } catch(e){ alert('Create failed: '+ (e.message||e)); }
    });

    // Sign in (email)
    signInBtn.addEventListener('click', async () => {
      const email = siEmail.value.trim(), password = siPassword.value;
      if (!email || !password) return alert('Enter email and password');
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch(e){ alert('Sign-in failed: '+(e.message||e)); }
    });

    // Reset
    resetBtn.addEventListener('click', async () => {
      const email = prompt('Enter your email for password reset:');
      if (!email) return;
      try { await sendPasswordResetEmail(auth, email); alert('Reset email sent.'); } catch(e){ alert('Reset failed: '+(e.message||e)); }
    });

    // Sign out
    openProfile.addEventListener('click', ()=> { show(viewProfile); });
    signOutBtn.addEventListener('click', async ()=> { await signOut(auth); });

    // On auth changes: update UI and presence
    let currentUser = null;
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        userBadge.textContent = user.displayName || user.email;
        document.getElementById('topSub').textContent = 'Signed in';
        signOutBtn.style.display = 'inline-block';
        show(viewChat);
        // write simple presence
        set(ref(db, 'presence/' + user.uid), { name: user.displayName || user.email, lastSeen: serverTimestamp() }).catch(()=>{});
        // populate profile form
        pfDisplay.value = user.displayName || '';
        pfEmail.value = user.email || '';
        appendSystemMessage('Welcome, ' + (user.displayName || user.email));
      } else {
        userBadge.textContent = 'Not signed in';
        document.getElementById('topSub').textContent = 'Small chat app';
        signOutBtn.style.display = 'none';
        show(viewLogin);
      }
    });

    // Chat: send message
    sendMsg.addEventListener('click', async () => {
      const text = msgInput.value.trim(); if (!text) return;
      if (!currentUser) return alert('Sign in first.');
      try {
        await push(ref(db, `rooms/general/messages`), { uid: currentUser.uid, name: currentUser.displayName || currentUser.email, text, ts: Date.now() });
        msgInput.value = '';
      } catch(e){ alert('Send failed: '+(e.message||e)); }
    });

    // Load messages (simple)
    const q = query(ref(db, 'rooms/general/messages'), limitToLast(200));
    onChildAdded(q, snap => {
      const m = snap.val();
      if (!m) return;
      const div = document.createElement('div');
      div.style.padding = '6px 8px'; div.style.borderRadius = '8px'; div.style.marginBottom = '8px';
      div.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.01), transparent)';
      const who = document.createElement('div'); who.style.fontWeight='600'; who.textContent = m.name || 'Unknown';
      const txt = document.createElement('div'); txt.textContent = m.text;
      const ts = document.createElement('div'); ts.className='muted'; ts.style.fontSize='12px'; ts.textContent = new Date(m.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      div.appendChild(who); div.appendChild(txt); div.appendChild(ts);
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    // Profile save & delete (basic)
    saveProfile.addEventListener('click', async () => {
      if (!currentUser) return alert('Sign in first.');
      const display = pfDisplay.value.trim(), newEmail = pfEmail.value.trim(), newPass = pfPass.value;
      try {
        if (display) await updateProfile(currentUser, { displayName: display });
        if (newEmail && newEmail !== currentUser.email) {
          // reauth required in production — for simplicity, attempt update and catch errors
          await updateEmail(currentUser, newEmail);
          alert('Email changed; you may need to re-login.');
        }
        if (newPass) {
          await updatePassword(currentUser, newPass);
          alert('Password changed; you may need to re-login.');
        }
        alert('Profile saved.');
      } catch(e){ alert('Save failed: '+(e.message||e)); }
    });

    deleteAcc.addEventListener('click', async () => {
      if (!currentUser) return;
      const ok = confirm('Delete account? This cannot be undone.');
      if (!ok) return;
      try {
        // remove DB profile and presence then delete user
        await set(ref(db, `users/${currentUser.uid}`), null);
        await set(ref(db, `presence/${currentUser.uid}`), null);
        await deleteUser(currentUser);
        alert('Account deleted.');
      } catch(e){ alert('Delete failed: '+(e.message||e)); }
    });

    backChat.addEventListener('click', ()=> { show(viewChat); });

    // Utility
    function appendSystemMessage(txt){
      const el = document.createElement('div'); el.className='muted'; el.style.margin='8px 0'; el.textContent = txt;
      messagesEl.appendChild(el);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Basic check to remind user to serve over HTTP
    if (location.protocol === 'file:') {
      alert('Warning: open this page using a local server (http://localhost) or deploy to GitHub Pages / Netlify. ES modules and Firebase will not work from file://');
    }
  </script>
</body>
</html>
