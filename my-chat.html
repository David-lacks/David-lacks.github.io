<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chudcord — All-in-One (Login · Chat · Profile)</title>

  <!-- App icon: save the image you uploaded as icons/chudcord.png in the repo root -->
  <link rel="icon" href="/icons/chudcord.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#5865f2">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#07101a; --sidebar:#0b1220; --panel:#111622; --muted:#9aa3ad; --accent:#5865f2; --white:#e6eef6;
      --input:#0f1622; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#071425);color:var(--white);min-height:100vh}
    a{color:inherit}

    /* Layout */
    .app{display:flex;min-height:100vh}
    /* left servers */
    .servers{width:72px;background:linear-gradient(180deg,var(--sidebar),#05070a);padding:8px;display:flex;flex-direction:column;gap:10px;align-items:center;border-right:1px solid rgba(255,255,255,0.03)}
    .server{width:48px;height:48px;border-radius:12px;background:linear-gradient(180deg,#26303b,#1b2228);display:flex;align-items:center;justify-content:center;color:var(--white);font-weight:700;font-size:18px;cursor:pointer;border:2px solid transparent}
    .server.active{border-color:rgba(88,101,242,0.8)}

    /* channels */
    .channels{width:260px;background:var(--panel);padding:12px;border-right:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:10px}
    .channels header{display:flex;justify-content:space-between;align-items:center}
    .channel-list{margin-top:8px;display:flex;flex-direction:column;gap:6px;overflow:auto}
    .channel{padding:8px;border-radius:6px;color:var(--muted);cursor:pointer}
    .channel.active{background:rgba(88,101,242,0.12);color:var(--white)}

    /* main chat */
    .chat{flex:1;display:flex;flex-direction:column}
    .chat-header{height:64px;display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .messages{flex:1;padding:20px;overflow:auto;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
    .composer{padding:12px 16px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:12px;align-items:center}
    .input{flex:1;background:linear-gradient(180deg,#0f1622,#0b1220);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);color:var(--white)}
    .btn{background:var(--accent);border:none;color:white;padding:10px 12px;border-radius:8px;cursor:pointer}

    /* members */
    .members{width:220px;padding:12px;background:var(--panel);border-left:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:10px}
    .avatar{width:96px;height:96px;border-radius:16px;background:linear-gradient(180deg,#334155,#1f2937);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:36px;margin-bottom:10px}

    /* views (login/profile/chat) */
    .view{display:none;padding:20px}
    .view.active{display:block}

    /* login card */
    .card{max-width:540px;margin:40px auto;background:linear-gradient(180deg,#2b2d31,#242629);border-radius:12px;padding:22px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 8px 30px rgba(2,6,23,0.5)}
    label{display:block;margin-top:12px;font-size:13px;color:var(--muted)}
    .field{width:100%;background:var(--input);border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03);color:var(--white);margin-top:8px;font-size:15px}
    .row{display:flex;gap:8px}
    .small-select{flex:1;background:var(--input);border-radius:10px;padding:12px;color:var(--white);border:1px solid rgba(255,255,255,0.03)}
    .muted{font-size:12px;color:var(--muted);margin-top:8px}

    /* topbar */
    .topbar{height:56px;background:linear-gradient(180deg,#07131a,#051018);display:flex;align-items:center;gap:12px;padding:0 16px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .brand{font-weight:700;margin-right:12px}
    .nav{margin-left:auto;display:flex;gap:8px;align-items:center}

    /* responsive (mobile similar to Discord) */
    @media (max-width:900px){
      .channels{display:none}
      .members{display:none}
      .servers{width:60px;position:fixed;left:0;top:0;bottom:0}
      .chat{margin-left:60px}
      .card{margin:12px auto;width:96%}
    }
    @media (max-width:520px){
      .card{padding:16px}
      .field{padding:10px}
      .btn{padding:12px}
    }
  </style>
</head>
<body>
  <!-- topbar with the provided app icon -->
  <div class="topbar" id="topbar" style="display:none">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="/icons/chudcord.png" alt="Chudcord" style="width:40px;height:40px;border-radius:8px"/>
      <div class="brand">Chudcord</div>
    </div>

    <div id="topRoom" style="font-weight:600;"></div>

    <div class="nav">
      <div id="topUser" style="color:var(--muted)"></div>
      <button id="goProfile" class="btn" style="background:rgba(255,255,255,0.06);color:var(--white)">Profile</button>
      <button id="goHome" class="btn" style="background:rgba(255,255,255,0.06);color:var(--white)">Home</button>
      <button id="signOutTop" class="btn" style="background:var(--danger);display:none">Clear identity</button>
    </div>
  </div>

  <main id="appRoot">
    <!-- LOGIN / SIGNUP view -->
    <section id="view-login" class="view active">
      <div class="card" role="main">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <div id="tabSignUp" style="flex:1;padding:10px;border-radius:10px;text-align:center;background:rgba(255,255,255,0.03);cursor:pointer;font-weight:600">Create Account</div>
          <div id="tabSignIn" style="flex:1;padding:10px;border-radius:10px;text-align:center;background:transparent;cursor:pointer;color:var(--muted)">Sign In</div>
        </div>

        <!-- Sign Up (no Auth) -->
        <div id="signupForm">
          <h2 style="margin:0 0 6px 0">Create an account</h2>
          <p class="muted">This site uses Realtime Database only. Your identity is stored locally (no Firebase Authentication).</p>

          <label>Email (optional)</label>
          <input id="suEmail" class="field" type="email" />

          <label>Display Name</label>
          <input id="suDisplayName" class="field" placeholder="What others will see" />

          <label>Username *</label>
          <input id="suUsername" class="field" placeholder="username (no spaces)" />

          <label>Password (ignored)</label>
          <input id="suPassword" class="field" type="password" />

          <label>Date of Birth *</label>
          <div class="row" style="margin-top:8px">
            <select id="dobMonth" class="small-select">
              <option value="">Month</option>
              <option>Jan</option><option>Feb</option><option>Mar</option><option>Apr</option><option>May</option><option>Jun</option>
              <option>Jul</option><option>Aug</option><option>Sep</option><option>Oct</option><option>Nov</option><option>Dec</option>
            </select>
            <select id="dobDay" class="small-select"><option value="">Day</option></select>
            <select id="dobYear" class="small-select"><option value="">Year</option></select>
          </div>

          <div style="display:flex;align-items:center;gap:10px;margin-top:14px">
            <input id="marketingOpt" type="checkbox" checked />
            <div class="muted">It's okay to send me updates and tips.</div>
          </div>

          <button id="createAccountBtn" class="btn" style="margin-top:16px">Create Account (local)</button>
          <div class="muted" style="text-align:center;margin-top:12px">This creates a local identity (no password stored on server).</div>
        </div>

        <!-- Sign In (local) -->
        <div id="signinForm" style="display:none">
          <h2 style="margin:0 0 6px 0">Sign in (local)</h2>
          <p class="muted">Enter your previously chosen username to resume your local identity on this browser.</p>

          <label>Username</label>
          <input id="siUsername" class="field" type="text" />

          <label>Display name (optional)</label>
          <input id="siDisplayName" class="field" type="text" />

          <button id="signInBtn" class="btn" style="margin-top:12px">Sign In Locally</button>
          <div style="display:flex;justify-content:space-between;margin-top:12px">
            <div class="muted">Need help? <span id="forgot" style="text-decoration:underline;cursor:pointer">?</span></div>
            <div><button id="backToChat" class="btn" style="background:rgba(255,255,255,0.06)">Continue as guest</button></div>
          </div>
        </div>
      </div>
    </section>

    <!-- CHAT view -->
    <section id="view-chat" class="view">
      <div class="app">
        <div class="servers" aria-hidden="true">
          <div class="server active">C</div>
          <div class="server">G</div>
          <div class="server">D</div>
        </div>

        <div class="channels" id="channelsPane">
          <header>
            <div>
              <h3 style="margin:0">Community</h3>
              <div id="userState" style="color:var(--muted);font-size:13px">Not set</div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="profileBtn" class="btn" style="background:rgba(255,255,255,0.06)">Profile</button>
              <button id="signToggle" class="btn" style="background:rgba(255,255,255,0.06)">Identity</button>
            </div>
          </header>

          <div style="margin-top:8px;color:var(--muted);font-size:12px">Text Channels</div>
          <div class="channel-list" id="channelList">
            <div class="channel active" data-room="general"># general</div>
            <div class="channel" data-room="random"># random</div>
            <div class="channel" data-room="help"># help</div>
          </div>
        </div>

        <main class="chat">
          <div class="chat-header">
            <div>
              <div id="roomTitle" style="font-weight:600"># general</div>
              <div id="roomTopic" style="color:var(--muted);font-size:13px">Realtime Database chat — no Authentication</div>
            </div>
          </div>

          <div class="messages" id="messages"></div>

          <div class="composer">
            <input id="messageInput" class="input" placeholder="Message #general" />
            <button id="sendBtn" class="btn">Send</button>
          </div>
        </main>

        <aside class="members" id="membersPane">
          <div style="font-weight:600">Members</div>
          <div id="memberList"></div>
        </aside>
      </div>
    </section>

    <!-- PROFILE view -->
    <section id="view-profile" class="view">
      <div style="max-width:940px;margin:28px auto;display:flex;gap:20px">
        <aside style="width:320px;background:var(--panel);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03)">
          <div style="display:flex;flex-direction:column;align-items:center">
            <div id="avatarPreview" class="avatar">U</div>
            <input id="fileInput" type="file" accept="image/*" style="display:none" />
            <button id="changePicBtn" class="btn" style="width:100%;margin-top:8px">Change Profile Picture</button>
            <div class="muted" style="text-align:center;margin-top:8px">Accepted: JPG, PNG. Max 5 MB.</div>
          </div>
        </aside>

        <section style="flex:1;background:var(--panel);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03)">
          <h2>Profile Settings</h2>

          <label>Display name</label>
          <input id="displayName" class="field"/>

          <label>Username (local id)</label>
          <input id="username" class="field" placeholder="username (no spaces)"/>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="saveProfileBtn" class="btn">Save</button>
            <button id="clearIdentityBtn" class="btn" style="background:var(--danger);margin-left:auto">Clear local identity</button>
          </div>

          <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:16px 0">

          <div class="muted">This app stores a small local identity in your browser (username, display name, small avatar). No Firebase Authentication is used.</div>
        </section>
      </div>
    </section>
  </main>

  <script type="module">
    // All handlers attach after DOMContentLoaded to avoid race issues
    document.addEventListener('DOMContentLoaded', () => {
      // quick check: must be served over http(s)
      if (location.protocol === 'file:') {
        alert('Warning: open this page using a local server (http://localhost) or deploy to GitHub Pages. ES modules require HTTP/HTTPS.');
      }

      // Populate DOB selects (fix earlier bug: day/year duplication)
      (function populateDOB(){
        const dayEl = document.getElementById('dobDay'), yearEl = document.getElementById('dobYear');
        if (!dayEl || !yearEl) return;
        dayEl.innerHTML = '<option value="">Day</option>';
        for(let d=1; d<=31; d++){ const o=document.createElement('option'); o.textContent=d; o.value=d; dayEl.appendChild(o); }
        const currentYear = new Date().getFullYear();
        yearEl.innerHTML = '<option value="">Year</option>';
        for(let y=currentYear; y>=1900; y--){ const o=document.createElement('option'); o.textContent=y; o.value=y; yearEl.appendChild(o); }
      })();

      // Local identity management (no auth)
      const UID_KEY = 'chudcord.uid';
      const NAME_KEY = 'chudcord.name';
      const USERNAME_KEY = 'chudcord.username';
      const AVATAR_KEY = 'chudcord.avatar';

      function makeUid(){ return 'u_' + Math.random().toString(36).slice(2,10); }
      let uid = localStorage.getItem(UID_KEY) || makeUid();
      localStorage.setItem(UID_KEY, uid);
      let displayName = localStorage.getItem(NAME_KEY) || '';
      let username = localStorage.getItem(USERNAME_KEY) || '';
      let avatarData = localStorage.getItem(AVATAR_KEY) || '';

      // UI refs
      const views = { login: document.getElementById('view-login'), chat: document.getElementById('view-chat'), profile: document.getElementById('view-profile') };
      const topbar = document.getElementById('topbar');
      const topUser = document.getElementById('topUser');
      const signOutTop = document.getElementById('signOutTop');

      const tabSignUp = document.getElementById('tabSignUp'), tabSignIn = document.getElementById('tabSignIn');
      const signupForm = document.getElementById('signupForm'), signinForm = document.getElementById('signinForm');

      const suUsername = document.getElementById('suUsername'), suDisplayName = document.getElementById('suDisplayName'), createAccountBtn = document.getElementById('createAccountBtn');
      const siUsername = document.getElementById('siUsername'), siDisplayName = document.getElementById('siDisplayName'), signInBtn = document.getElementById('signInBtn');
      const backToChat = document.getElementById('backToChat');
      const profileBtn = document.getElementById('profileBtn'), signToggle = document.getElementById('signToggle');

      const userState = document.getElementById('userState');

      const messagesEl = document.getElementById('messages'), sendBtn = document.getElementById('sendBtn'), messageInput = document.getElementById('messageInput');
      const channelList = document.getElementById('channelList');
      const memberList = document.getElementById('memberList');
      const roomTitle = document.getElementById('roomTitle');

      // Profile elements
      const avatarPreview = document.getElementById('avatarPreview'), fileInput = document.getElementById('fileInput'), changePicBtn = document.getElementById('changePicBtn');
      const displayNameEl = document.getElementById('displayName'), usernameEl = document.getElementById('username'), saveProfileBtn = document.getElementById('saveProfileBtn'), clearIdentityBtn = document.getElementById('clearIdentityBtn');

      // Show selected view
      function showView(name){
        Object.values(views).forEach(v=>v.classList.remove('active'));
        views[name].classList.add('active');
        topbar.style.display = (name === 'chat' || name === 'profile') ? 'flex' : 'none';
      }

      // initialize UI from local storage identity
      function refreshIdentityUI(){
        displayName = localStorage.getItem(NAME_KEY) || displayName;
        username = localStorage.getItem(USERNAME_KEY) || username;
        avatarData = localStorage.getItem(AVATAR_KEY) || avatarData;

        userState.textContent = displayName ? `${displayName} (${username||'anon'})` : (username ? username : 'No identity');
        document.getElementById('profileAvatar')?.style && (document.getElementById('profileAvatar').textContent = '');
        if (avatarData){
          avatarPreview.style.backgroundImage = `url(${avatarData})`;
          avatarPreview.textContent = '';
        } else {
          avatarPreview.style.backgroundImage = '';
          avatarPreview.textContent = (displayName || username || uid).slice(0,2).toUpperCase();
        }
        // profile fields
        displayNameEl.value = displayName;
        usernameEl.value = username;
      }
      refreshIdentityUI();

      // Tab switching
      tabSignUp.addEventListener('click', ()=>{ signupForm.style.display='block'; signinForm.style.display='none'; tabSignUp.style.background='rgba(255,255,255,0.03)'; tabSignIn.style.background='transparent'; });
      tabSignIn.addEventListener('click', ()=>{ signupForm.style.display='none'; signinForm.style.display='block'; tabSignIn.style.background='rgba(255,255,255,0.03)'; tabSignUp.style.background='transparent'; });

      // Local create account: store identity in localStorage and write to DB users/<uid>/profile and presence
      createAccountBtn.addEventListener('click', async () => {
        const uname = (suUsername.value||'').trim();
        const dname = (suDisplayName.value||'').trim() || uname || ('User'+uid.slice(2,6));
        if (!uname){ return alert('Please enter a username'); }
        username = uname; displayName = dname;
        localStorage.setItem(USERNAME_KEY, username);
        localStorage.setItem(NAME_KEY, displayName);
        refreshIdentityUI();
        // write profile and presence to DB
        try {
          await ensureDbWrite(`users/${uid}/profile`, { name: displayName, username, avatar: avatarData, updatedAt: Date.now() });
          await ensureDbWrite(`presence/${uid}`, { name: displayName, username, avatar: avatarData, lastSeen: Date.now() });
        } catch(err){
          console.error(err);
          alert('Could not save profile to database. Check Realtime DB rules and that you are serving over HTTP/HTTPS.');
        }
        showView('chat');
      });

      // Local "sign in" (resume) — sets local name/username and writes presence
      signInBtn.addEventListener('click', async () => {
        const uname = (siUsername.value||'').trim();
        const dname = (siDisplayName.value||'').trim();
        if (!uname){ return alert('Enter a username to sign in locally'); }
        username = uname; if (dname) displayName = dname;
        localStorage.setItem(USERNAME_KEY, username);
        localStorage.setItem(NAME_KEY, displayName);
        refreshIdentityUI();
        try {
          await ensureDbWrite(`users/${uid}/profile`, { name: displayName, username, avatar: avatarData, updatedAt: Date.now() });
          await ensureDbWrite(`presence/${uid}`, { name: displayName, username, avatar: avatarData, lastSeen: Date.now() });
        } catch(err){
          console.error(err);
        }
        showView('chat');
      });

      // Continue as guest
      backToChat.addEventListener('click', () => {
        if (!displayName && !username) {
          // assign a quick displayName
          displayName = 'Guest' + uid.slice(-4);
          localStorage.setItem(NAME_KEY, displayName);
        }
        refreshIdentityUI();
        showView('chat');
      });

      // Profile navigation
      profileBtn.addEventListener('click', ()=> showView('profile'));
      signToggle.addEventListener('click', ()=> showView('login'));
      document.getElementById('goHome').addEventListener('click', ()=> showView('chat'));
      document.getElementById('signOutTop').addEventListener('click', () => {
        // Clear local identity but keep uid
        localStorage.removeItem(NAME_KEY);
        localStorage.removeItem(USERNAME_KEY);
        localStorage.removeItem(AVATAR_KEY);
        displayName = username = avatarData = '';
        refreshIdentityUI();
        showView('login');
      });

      // Profile: change picture (resized dataURL)
      changePicBtn.addEventListener('click', ()=> fileInput.click());
      fileInput.addEventListener('change', async (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        if (f.size > 5 * 1024 * 1024) return alert('File too large (max 5MB).');
        const dataUrl = await readImageFileToDataURL(f, 128);
        avatarData = dataUrl;
        localStorage.setItem(AVATAR_KEY, avatarData);
        refreshIdentityUI();
      });

      // Save profile button
      saveProfileBtn.addEventListener('click', async () => {
        const newName = (displayNameEl.value || '').trim();
        const newUsername = (usernameEl.value || '').trim();
        if (!newUsername) return alert('Username cannot be empty');
        username = newUsername; displayName = newName || newUsername;
        localStorage.setItem(USERNAME_KEY, username);
        localStorage.setItem(NAME_KEY, displayName);
        localStorage.setItem(AVATAR_KEY, avatarData || '');
        refreshIdentityUI();
        try {
          await ensureDbWrite(`users/${uid}/profile`, { name: displayName, username, avatar: avatarData || '', updatedAt: Date.now() });
          await ensureDbWrite(`presence/${uid}`, { name: displayName, username, avatar: avatarData || '', lastSeen: Date.now() });
          alert('Profile saved.');
          showView('chat');
        } catch(err){
          console.error(err);
          alert('Failed to save profile to DB. Check Realtime DB rules and HTTP hosting.');
        }
      });

      // Clear identity local button
      clearIdentityBtn.addEventListener('click', () => {
        localStorage.removeItem(NAME_KEY);
        localStorage.removeItem(USERNAME_KEY);
        localStorage.removeItem(AVATAR_KEY);
        displayName = username = avatarData = '';
        refreshIdentityUI();
        alert('Local identity cleared.');
        showView('login');
      });

      // UTIL: read image and resize to dataURL
      function readImageFileToDataURL(file, maxSize=128){
        return new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.onerror = reject;
          r.onload = () => {
            const img = new Image();
            img.onload = () => {
              let w = img.width, h = img.height;
              if (w > h && w > maxSize){ h = Math.round(h * (maxSize / w)); w = maxSize; }
              else if (h > w && h > maxSize){ w = Math.round(w * (maxSize / h)); h = maxSize; }
              const c = document.createElement('canvas');
              c.width = w; c.height = h;
              const ctx = c.getContext('2d');
              ctx.drawImage(img,0,0,w,h);
              resolve(c.toDataURL('image/png', 0.9));
            };
            img.onerror = reject;
            img.src = r.result;
          };
          r.readAsDataURL(file);
        });
      }

      // ---------------------------------------------------------------------
      // Firebase Realtime Database usage (no Authentication)
      // Uses modular SDK but loads inside DOMContentLoaded to avoid early errors
      // ---------------------------------------------------------------------
      let db = null;
      (async function initFirebaseDB(){
        try {
          const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js');
          const dbMod = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js');
          const { getDatabase, ref, push, onChildAdded, query, limitToLast, set, get } = dbMod;
          const firebaseConfig = {
            apiKey: "AIzaSyClpOt6HnUl0qwFr1NytfuSurhBoagCHL8",
            authDomain: "chatting-29d11.firebaseapp.com",
            databaseURL: "https://chatting-29d11-default-rtdb.firebaseio.com",
            projectId: "chatting-29d11",
            storageBucket: "chatting-29d11.firebasestorage.app",
            messagingSenderId: "1018454045492",
            appId: "1:1018454045492:web:2509f900062e9c15f36b61"
          };
          initializeApp(firebaseConfig);
          db = getDatabase();
          // load default room messages and subscribe
          subscribeRoom(currentRoom || 'general');
          // initial presence write (best-effort)
          try { await ensureDbWrite(`presence/${uid}`, { name: displayName || '', username: username || '', avatar: avatarData || '', lastSeen: Date.now() }); } catch(e){ console.warn('presence write failed', e); }
          // load presence once
          loadPresenceOnce();
        } catch(e){
          console.error('Firebase DB init failed', e);
          alert('Failed to initialize Firebase Realtime Database. Open DevTools console for details.');
        }
      })();

      // helper to push/update with safe error handling
      async function ensureDbWrite(path, value){
        if (!db) throw new Error('DB not initialized');
        const dbMod = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js');
        return set(dbMod.ref(db, path), value);
      }

      // send message handler
      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keydown', function(e){ if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

      async function sendMessage(){
        const text = (messageInput.value || '').trim();
        if (!text) return;
        const name = displayName || username || ('User'+uid.slice(-4));
        const msg = { uid, name, username: username||'', avatar: avatarData||'', text, ts: Date.now() };
        if (!db){
          alert('Database not ready yet. Wait a moment and try again.');
          return;
        }
        try {
          const dbMod = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js');
          await dbMod.push(dbMod.ref(db, `rooms/${currentRoom}/messages`), msg);
          messageInput.value = '';
        } catch(err){
          console.error(err);
          alert('Failed to send message. Check Realtime DB rules and HTTP hosting.');
        }
      }

      // Subscribe to room messages (uses onChildAdded)
      let currentRoom = 'general';
      function subscribeRoom(room){
        if (!db) { setTimeout(()=>subscribeRoom(room), 300); return; }
        currentRoom = room;
        messagesEl.innerHTML = '';
        (async ()=>{
          const dbMod = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js');
          const q = dbMod.query(dbMod.ref(db, `rooms/${room}/messages`), dbMod.limitToLast(200));
          dbMod.onChildAdded(q, snap => {
            const m = snap.val();
            if (m) renderMessage(m);
          });
        })();
      }

      // load messages for selected room
      function loadMessages(room){
        messagesEl.innerHTML = '';
        subscribeRoom(room);
      }

      // render message into DOM
      function renderMessage(m){
        const el = document.createElement('div');
        el.style.display='flex'; el.style.gap='10px'; el.style.marginBottom='12px';
        const av = document.createElement('div'); av.style.width='40px'; av.style.height='40px'; av.style.borderRadius='8px';
        if (m.avatar){ av.style.backgroundImage = `url(${m.avatar})`; av.style.backgroundSize='cover'; } else { av.style.background='linear-gradient(180deg,#334155,#1f2937)'; av.style.color='white'; av.style.display='flex'; av.style.alignItems='center'; av.style.justifyContent='center'; av.textContent=(m.name||'U').slice(0,2).toUpperCase(); }
        const body = document.createElement('div');
        const author = document.createElement('div'); author.style.fontWeight='600'; author.textContent = m.name || 'Unknown';
        const text = document.createElement('div'); text.textContent = m.text; text.style.marginTop='4px';
        const ts = document.createElement('div'); ts.className='muted'; ts.style.fontSize='12px'; ts.textContent = new Date(m.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        body.appendChild(author); body.appendChild(text); body.appendChild(ts);
        el.appendChild(av); el.appendChild(body);
        messagesEl.appendChild(el);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      // channel switching
      channelList.addEventListener('click', (ev)=> {
        const el = ev.target.closest('.channel'); if(!el) return;
        document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
        const room = el.dataset.room;
        roomTitle.textContent = '# ' + room;
        subscribeRoom(room);
      });

      // Presence: load once current presence list
      async function loadPresenceOnce(){
        if (!db) return;
        try {
          const dbMod = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js');
          const pSnap = await dbMod.get(dbMod.ref(db, 'presence'));
          memberList.innerHTML = '';
          if (!pSnap.exists()) return;
          const val = pSnap.val();
          for (const k of Object.keys(val)){
            const it = val[k];
            const item = document.createElement('div');
            item.style.display='flex'; item.style.gap='8px'; item.style.alignItems='center'; item.style.marginBottom='8px';
            const a = document.createElement('div'); a.style.width='36px'; a.style.height='36px'; a.style.borderRadius='6px'; a.style.display='flex'; a.style.alignItems='center'; a.style.justifyContent='center';
            if (it.avatar){ a.style.backgroundImage = `url(${it.avatar})`; a.style.backgroundSize='cover'; }
            else { a.style.background='rgba(255,255,255,0.03)'; a.textContent = (it.name||'U').slice(0,2).toUpperCase(); }
            const n = document.createElement('div'); n.textContent = it.name || 'Anonymous'; n.style.color = 'var(--muted)'; n.style.fontSize='13px';
            item.appendChild(a); item.appendChild(n);
            memberList.appendChild(item);
          }
        } catch(err){ console.warn('loadPresenceOnce failed', err); }
      }

      // periodically update our presence entry
      setInterval(async ()=> {
        if (!db) return;
        try {
          const dbMod = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js');
          await dbMod.set(dbMod.ref(db, `presence/${uid}`), { name: displayName || '', username: username || '', avatar: avatarData || '', lastSeen: Date.now() });
        } catch(err){ /* ignore */ }
      }, 10000);

      // initial render identity & view
      refreshIdentityUI();
      showView('login');

    }); // DOMContentLoaded end
  </script>
</body>
</html>
